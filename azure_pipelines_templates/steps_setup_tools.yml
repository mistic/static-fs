steps:
  - bash: |
      "##vso[task.setvariable variable=NVMRC]$(cat .nvmrc)"
    displayName: 'Read .nvmrc file into var NVMRC'
  - task: NodeTool@0
    inputs:
      versionSpec: "$(NVMRC)"
    displayName: 'Install required Node.js version'
  - powershell: Rename-Item C:\npm\prefix\yarn.cmd C:\npm\prefix\yarn_default.cmd; Rename-Item C:\npm\prefix\yarnpkg.cmd C:\npm\prefix\yarnpkg_default.cmd
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: 'Remove default Yarn on windows'
  - task: Npm@1
    inputs:
      command: custom
      # As we have our yarn vendored we can use that version
      # even if we update the needed version in the package.json
      customCommand: i -g yarn@1.21.1
    displayName: 'Install required Yarn version'
  - task: Npm@1
    inputs:
      command: custom
      customCommand: i -g node-gyp@5.0.3
    displayName: 'Install required node-gyp version'
  - powershell: npm prefix -g | % {npm config set node_gyp "$_\node_modules\node-gyp\bin\node-gyp.js"}
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: 'Config latest v5 node-gyp to work with vs2019'
  - script: |
      node -v
      yarn -v
    displayName: 'Print tool versions'
  - script: yarn install
    displayName: 'Install dependencies'
