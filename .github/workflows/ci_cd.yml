name: 'CI & CD'

on:
  push:
    branches:
      - master

  pull_request:
    branches:
      - master

  schedule:
    - cron:  '0 12 1-7 * Sun'

env:
  NODE_VERSION: '10.19.0'
  YARN_VERSION: '1.21.1'
  UBUNTU_VERSION: 'ubuntu-18.04'
  MACOS_VERSION: 'macos-10.15'
  WINDOWS_VERSION: 'windows-2019'

jobs:
  skip_ci:
    name: 'Skip CI Check'
    runs-on: ${{ env.UBUNTU_VERSION }}
    steps:
      - run: echo "[Skip CI] ${{ contains(github.event.head_commit.message, '[skip ci]') }}"

  lint:
    name: 'Lint'
    needs: skip_ci
    runs-on: ${{ env.UBUNTU_VERSION }}
    if: contains(github.event.head_commit.message, '[skip ci]') == false
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v1
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm i -g yarn@${{ env.YARN_VERSION }}
      - run: yarn install
      - name: 'Assert conventional commits format'
        uses: wagoid/commitlint-github-action@v1
        with:
          configFile: '.commitlintrc.js'
      - name: 'Run eslint'
        run: yarn lint

  test_for_platform:
    name: 'Test for platform'
    needs: lint
    runs-on: ${{matrix.os}}
    strategy:
      max-parallel: 3
      matrix:
        os: [${{ env.UBUNTU_VERSION }}, ${{ env.MACOS_VERSION }}, ${{ env.WINDOWS_VERSION }}]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm i -g yarn@${{ env.YARN_VERSION }}
      - run: yarn install
      - name: 'Run tests on ${{runner.os}}'
        run: yarn test

  release_npm_github:
    name: 'Release on npm and github'
    needs: test_for_platform
    runs-on: ${{ env.UBUNTU_VERSION }}
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm i -g yarn@${{ env.YARN_VERSION }}
      - run: yarn install
      - name: 'Run script yarn script to release new version'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: yarn release:dryRun
